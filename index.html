<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키오스크 슬라이더</title>
    
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        
        .swiper {
            width: 100vw;
            height: 100vh;
        }
        
        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .swiper-slide video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <!-- Swiper -->
    <div class="swiper">
        <div class="swiper-wrapper" id="swiper-wrapper">
            <!-- 슬라이드가 동적으로 생성됩니다 -->
        </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script>
        // 지원하는 파일 확장자
        const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
        const videoTypes = ['mp4', 'webm', 'ogg'];
        
        // 파일 타입 확인 함수
        function getFileType(extension) {
            const ext = extension.toLowerCase();
            if (imageTypes.includes(ext)) {
                return 'image';
            } else if (videoTypes.includes(ext)) {
                return 'video';
            }
            return 'unknown';
        }
        
        // 파일 존재 여부 확인 함수 (이미지)
        function checkImageExists(filePath) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = filePath;
            });
        }
        
        // 파일 존재 여부 확인 함수 (영상)
        function checkVideoExists(filePath) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.oncanplay = () => {
                    resolve(true);
                    video.src = '';
                };
                video.onerror = () => resolve(false);
                video.src = filePath;
                video.load();
            });
        }
        
        // 슬라이드 생성 함수
        async function createSlides() {
            const wrapper = document.getElementById('swiper-wrapper');
            const slides = [];
            
            // 01부터 10까지 파일 확인
            for (let i = 1; i <= 10; i++) {
                const num = String(i).padStart(2, '0');
                let foundFile = null;
                let fileType = null;
                
                // 이미지 확장자 먼저 확인
                for (const ext of imageTypes) {
                    const filePath = `upload/${num}.${ext}`;
                    const exists = await checkImageExists(filePath);
                    if (exists) {
                        foundFile = filePath;
                        fileType = 'image';
                        break;
                    }
                }
                
                // 이미지를 찾지 못했으면 영상 확장자 확인
                if (!foundFile) {
                    for (const ext of videoTypes) {
                        const filePath = `upload/${num}.${ext}`;
                        const exists = await checkVideoExists(filePath);
                        if (exists) {
                            foundFile = filePath;
                            fileType = 'video';
                            break;
                        }
                    }
                }
                
                // 파일을 찾았으면 슬라이드 생성
                if (foundFile) {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    
                    if (fileType === 'image') {
                        slide.innerHTML = `<img src="${foundFile}" alt="Slide ${num}">`;
                    } else if (fileType === 'video') {
                        slide.innerHTML = `<video src="${foundFile}" muted playsinline></video>`;
                    }
                    
                    wrapper.appendChild(slide);
                    slides.push({ file: foundFile, type: fileType });
                }
            }
            
            return slides;
        }
        
        // Swiper 초기화 및 시작
        let swiper;
        let previousVideo = null; // 이전 영상 참조 저장
        
        async function initSwiper() {
            const slides = await createSlides();
            
            if (slides.length === 0) {
                console.warn('슬라이드할 파일이 없습니다.');
                return;
            }
            
            // Swiper 초기화
            swiper = new Swiper('.swiper', {
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
                loop: slides.length > 1, // 슬라이드가 2개 이상일 때만 loop 활성화
                speed: 2000,
                allowTouchMove: false,
                autoplay: {
                    delay: 12000, // 기본 12초 (이미지용)
                    disableOnInteraction: false,
                },
                on: {
                    init: function() {
                        setupSlideAutoplay(this);
                    },
                    slideChange: function() {
                        setupSlideAutoplay(this);
                    }
                }
            });
            
            // 초기 설정
            setupSlideAutoplay(swiper);
        }
        
        // 슬라이드별 autoplay 설정
        function setupSlideAutoplay(swiperInstance) {
            // 이전 영상 정리
            if (previousVideo) {
                previousVideo.onended = null;
                previousVideo.pause();
                previousVideo.currentTime = 0;
                previousVideo = null;
            }
            
            // 현재 활성 슬라이드 찾기 (Loop 모드 고려)
            const activeIndex = swiperInstance.activeIndex;
            const realIndex = swiperInstance.realIndex;
            const slides = swiperInstance.slides;
            let currentSlide = null;
            
            // Loop 모드가 활성화된 경우 realIndex를 사용하여 실제 슬라이드 찾기
            if (swiperInstance.params.loop) {
                // 원본 슬라이드 컨테이너에서 실제 슬라이드 찾기
                const wrapper = swiperInstance.wrapperEl;
                if (wrapper) {
                    const originalSlides = wrapper.querySelectorAll('.swiper-slide:not(.swiper-slide-duplicate)');
                    if (originalSlides[realIndex]) {
                        currentSlide = originalSlides[realIndex];
                    }
                }
                
                // 위 방법이 실패한 경우 activeIndex의 슬라이드 사용
                if (!currentSlide && slides[activeIndex]) {
                    currentSlide = slides[activeIndex];
                }
            } else {
                // Loop 모드가 아닌 경우 activeIndex 사용
                currentSlide = slides[activeIndex];
            }
            
            if (!currentSlide || !currentSlide.querySelector) {
                console.warn('슬라이드를 찾을 수 없습니다. activeIndex:', activeIndex, 'realIndex:', realIndex);
                return;
            }
            
            const img = currentSlide.querySelector('img');
            const video = currentSlide.querySelector('video');
            
            // 현재 슬라이드가 이미지인 경우
            if (img) {
                // autoplay 재시작 (더 안전한 방법)
                swiperInstance.autoplay.stop();
                swiperInstance.params.autoplay.delay = 12000; // 12초
                // 약간의 지연 후 재시작하여 타이밍 이슈 방지
                setTimeout(() => {
                    if (swiperInstance && swiperInstance.autoplay) {
                        swiperInstance.autoplay.start();
                    }
                }, 100);
            }
            
            // 현재 슬라이드가 영상인 경우
            if (video) {
                // 이전 영상 참조 저장
                previousVideo = video;
                
                swiperInstance.autoplay.stop();
                
                // 기존 이벤트 리스너 완전히 제거
                video.onended = null;
                video.onerror = null;
                
                // 영상 재생
                video.currentTime = 0;
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // 재생 성공
                    }).catch(e => {
                        console.error('영상 재생 실패:', e);
                        // 재생 실패 시 3초 후 다음 슬라이드로
                        setTimeout(() => {
                            if (swiperInstance && swiperInstance.slideNext) {
                                swiperInstance.slideNext();
                            }
                        }, 3000);
                    });
                }
                
                // 영상 재생 완료 시 다음 슬라이드로 (안전한 이벤트 바인딩)
                const handleVideoEnd = function() {
                    if (swiperInstance && swiperInstance.slideNext) {
                        swiperInstance.slideNext();
                    }
                };
                
                video.onended = handleVideoEnd;
            }
        }
        
        // 초기화 실행
        initSwiper();
    </script>
</body>
</html>
