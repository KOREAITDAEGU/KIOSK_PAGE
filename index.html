<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키오스크 슬라이더</title>
    
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        
        .swiper {
            width: 100vw;
            height: 100vh;
        }
        
        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .swiper-slide video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <!-- Swiper -->
    <div class="swiper">
        <div class="swiper-wrapper" id="swiper-wrapper">
            <!-- 슬라이드가 동적으로 생성됩니다 -->
        </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script>
        // 지원하는 파일 확장자
        const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
        const videoTypes = ['mp4', 'webm', 'ogg'];
        
        // 파일 타입 확인 함수
        function getFileType(extension) {
            const ext = extension.toLowerCase();
            if (imageTypes.includes(ext)) {
                return 'image';
            } else if (videoTypes.includes(ext)) {
                return 'video';
            }
            return 'unknown';
        }
        
        // 파일 존재 여부 확인 함수 (이미지)
        function checkImageExists(filePath) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = filePath;
            });
        }
        
        // 파일 존재 여부 확인 함수 (영상)
        function checkVideoExists(filePath) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.oncanplay = () => {
                    resolve(true);
                    video.src = '';
                };
                video.onerror = () => resolve(false);
                video.src = filePath;
                video.load();
            });
        }
        
        // 슬라이드 생성 함수
        async function createSlides() {
            const wrapper = document.getElementById('swiper-wrapper');
            const slides = [];
            
            // 01부터 10까지 파일 확인
            for (let i = 1; i <= 10; i++) {
                const num = String(i).padStart(2, '0');
                let foundFile = null;
                let fileType = null;
                
                // 이미지 확장자 먼저 확인
                for (const ext of imageTypes) {
                    const filePath = `upload/${num}.${ext}`;
                    const exists = await checkImageExists(filePath);
                    if (exists) {
                        foundFile = filePath;
                        fileType = 'image';
                        break;
                    }
                }
                
                // 이미지를 찾지 못했으면 영상 확장자 확인
                if (!foundFile) {
                    for (const ext of videoTypes) {
                        const filePath = `upload/${num}.${ext}`;
                        const exists = await checkVideoExists(filePath);
                        if (exists) {
                            foundFile = filePath;
                            fileType = 'video';
                            break;
                        }
                    }
                }
                
                // 파일을 찾았으면 슬라이드 생성
                if (foundFile) {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    
                    if (fileType === 'image') {
                        slide.innerHTML = `<img src="${foundFile}" alt="Slide ${num}">`;
                    } else if (fileType === 'video') {
                        slide.innerHTML = `<video src="${foundFile}" muted playsinline></video>`;
                    }
                    
                    wrapper.appendChild(slide);
                    slides.push({ file: foundFile, type: fileType });
                }
            }
            
            return slides;
        }
        
        // Swiper 초기화 및 시작
        let swiper;
        let previousVideo = null; // 이전 영상 참조 저장
        let totalSlideCount = 0; // 전체 슬라이드 개수
        let repeatCount = 0; // 전체 반복 회수 (회전수)
        let previousRealIndex = -1; // 이전 realIndex 추적
        
        async function initSwiper() {
            const slides = await createSlides();
            
            if (slides.length === 0) {
                console.warn('슬라이드할 파일이 없습니다.');
                return;
            }
            
            // 전체 슬라이드 개수 저장
            totalSlideCount = slides.length;
            // 반복 카운터 초기화
            repeatCount = 0;
            previousRealIndex = -1;
            
            // Swiper 초기화
            swiper = new Swiper('.swiper', {
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
                loop: slides.length > 1, // 슬라이드가 2개 이상일 때만 loop 활성화
                speed: 2000,
                allowTouchMove: false,
                autoplay: {
                    delay: 12000, // 기본 12초 (이미지용)
                    disableOnInteraction: false,
                },
                on: {
                    init: function() {
                        // 초기 슬라이드 인덱스 기록
                        previousRealIndex = this.realIndex;
                        setupSlideAutoplay(this);
                    },
                    slideChange: function() {
                        const currentRealIndex = this.realIndex;
                        
                        // 마지막 슬라이드에서 첫 번째 슬라이드로 돌아왔을 때 (한 바퀴 완료)
                        // previousRealIndex가 마지막 인덱스이고, currentRealIndex가 0이면 한 바퀴 완료
                        if (previousRealIndex === totalSlideCount - 1 && currentRealIndex === 0) {
                            repeatCount++;
                            
                            // 3회 반복(회전) 이상이면 초기화
                            if (repeatCount >= 3) {
                                resetSwiper();
                                return;
                            }
                        }
                        
                        // 이전 인덱스 업데이트
                        previousRealIndex = currentRealIndex;
                        
                        setupSlideAutoplay(this);
                    }
                }
            });
            
            // 초기 설정
            setupSlideAutoplay(swiper);
        }
        
        // 슬라이드별 autoplay 설정
        function setupSlideAutoplay(swiperInstance) {
            // 이전 영상 정리
            if (previousVideo) {
                previousVideo.onended = null;
                previousVideo.pause();
                previousVideo.currentTime = 0;
                previousVideo = null;
            }
            
            // 현재 활성 슬라이드 찾기 - activeIndex를 직접 사용 (가장 안전한 방법)
            const activeIndex = swiperInstance.activeIndex;
            const slides = swiperInstance.slides;
            const currentSlide = slides[activeIndex];
            
            if (!currentSlide || !currentSlide.querySelector) {
                console.warn('슬라이드를 찾을 수 없습니다. activeIndex:', activeIndex);
                return;
            }
            
            const img = currentSlide.querySelector('img');
            const video = currentSlide.querySelector('video');
            
            // 현재 슬라이드가 이미지인 경우
            if (img) {
                // autoplay가 이미 실행 중이면 delay만 업데이트
                if (swiperInstance.autoplay.running) {
                    swiperInstance.params.autoplay.delay = 12000; // 12초
                } else {
                    // autoplay가 중지된 경우에만 재시작
                    swiperInstance.params.autoplay.delay = 12000; // 12초
                    swiperInstance.autoplay.start();
                }
            }
            
            // 현재 슬라이드가 영상인 경우
            if (video) {
                // 이전 영상 참조 저장
                previousVideo = video;
                
                // autoplay 중지
                swiperInstance.autoplay.stop();
                
                // 기존 이벤트 리스너 완전히 제거
                video.onended = null;
                video.onerror = null;
                
                // 영상 재생
                video.currentTime = 0;
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // 재생 성공
                    }).catch(e => {
                        console.error('영상 재생 실패:', e);
                        // 재생 실패 시 3초 후 다음 슬라이드로
                        setTimeout(() => {
                            if (swiperInstance && swiperInstance.slideNext) {
                                swiperInstance.slideNext();
                            }
                        }, 3000);
                    });
                }
                
                // 영상 재생 완료 시 다음 슬라이드로 (안전한 이벤트 바인딩)
                const handleVideoEnd = function() {
                    // 이벤트가 현재 영상에 바인딩되어 있는지 확인
                    if (video === previousVideo && swiperInstance && swiperInstance.slideNext) {
                        swiperInstance.slideNext();
                    }
                };
                
                video.onended = handleVideoEnd;
            }
        }
        
        // Swiper 초기화 함수 (3회 주기마다 호출)
        async function resetSwiper() {
            // 모든 비디오 정리 (재생 중이어도 강제 중지)
            if (previousVideo) {
                previousVideo.onended = null;
                previousVideo.onerror = null;
                previousVideo.pause();
                previousVideo.currentTime = 0;
                previousVideo = null;
            }
            
            // 모든 슬라이드의 비디오 정리
            const allVideos = document.querySelectorAll('.swiper-slide video');
            allVideos.forEach(video => {
                video.onended = null;
                video.onerror = null;
                video.pause();
                video.currentTime = 0;
            });
            
            // Swiper 인스턴스 제거
            if (swiper) {
                swiper.destroy(true, true);
                swiper = null;
            }
            
            // 반복 카운터 리셋
            repeatCount = 0;
            previousRealIndex = -1;
            
            // Swiper 재초기화
            await initSwiper();
        }
        
        // 초기화 실행
        initSwiper();
    </script>
</body>
</html>
